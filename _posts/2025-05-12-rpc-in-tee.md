---
title: "rpc in tee"
date: 2025-05-12
categories: [blog, development]
tags: [rpc, tee]
---

# RPC in Trusted Execution Environments (TEEs)

Trusted Execution Environments (TEEs) are becoming increasingly important in modern computing, especially in domains where data confidentiality and integrity are paramount, such as secure payments, digital rights management, and mobile security. One crucial component that enables interaction between the TEE and the outside world is the **Remote Procedure Call (RPC)** mechanism.

This article explores the concept of RPC in the context of TEEs, its architectural role, how it works, and the challenges associated with it.

---

## What is a Trusted Execution Environment (TEE)?

A **Trusted Execution Environment** is an isolated area within a processor that guarantees code and data loaded inside to be protected with respect to confidentiality and integrity. It runs alongside the main operating system (often referred to as the *Rich Execution Environment*, or REE) but is isolated from it.

Examples of TEEs include:

- ARM TrustZone (widely used in mobile and embedded devices)
- Intel SGX (Software Guard Extensions)
- AMD SEV (Secure Encrypted Virtualization)

---

## The Need for RPC in a TEE

TEEs are purposely limited in terms of available resources. They do not have direct access to devices like network interfaces, file systems, or user interfaces. Yet, secure applications running in a TEE (called **Trusted Applications**, or TAs) often need to perform operations that involve the non-secure world.

To handle such operations securely, TEEs use **RPC mechanisms** to request services from the **Normal World** (non-secure world, typically the main OS). These calls are controlled and monitored to prevent security breaches.

---

## How RPC Works in a TEE Context

Letâ€™s take ARM TrustZone as an example:

1. **Client Application (CA)** in the REE invokes a command to the **Trusted Application (TA)** in the TEE.
2. The TEE OS processes the request.
3. If the TA needs to perform an operation it cannot handle (e.g., reading a file), it triggers an **RPC request** back to the REE.
4. The TEE pauses TA execution and switches context to the REE, sending the RPC parameters.
5. The REE handles the request (e.g., opens a file, reads content) and sends the response back to the TEE.
6. The TEE resumes the TA and returns the result.

This interaction is bi-directional:

- **REE â†’ TEE**: Normal world calls into the secure world.
- **TEE â†’ REE (RPC)**: Secure world asks the normal world to perform an external operation.

---

## Use Cases for RPC in TEEs

- **Accessing File Systems**: TAs often need to load or store data, which may reside on a normal-world file system.
- **Interacting with Hardware**: Devices like GPS, displays, and cameras are typically controlled by drivers in the REE.
- **Networking**: Since TAs donâ€™t have access to network stacks, they may ask the REE to send/receive data.
- **Logging and Debugging**: Secure applications often rely on REE-based loggers for output.

---

## Security Considerations

While RPC expands the capabilities of TAs, it introduces a potential **attack surface**. Misuse or poor validation of RPC parameters can lead to:

- **Privilege escalation** if untrusted responses are not validated.
- **Information leakage** if sensitive data is exposed to the REE.
- **Denial of Service (DoS)** if the REE fails to respond to RPC calls.

To mitigate these risks:

- Always validate data exchanged over RPC.
- Use strict access control and input sanitization.
- Minimize reliance on RPC when possible.

---

## Implementation: Example from OP-TEE

[OP-TEE](https://www.op-tee.org/) is a popular open-source TEE implementation for ARM TrustZone. It supports RPC through a mechanism where the secure world sends a **yielding request** to the REE.

In OP-TEE:

- RPC types are defined (e.g., `OPTEE_RPC_CMD_SHM_ALLOC`, `OPTEE_RPC_CMD_FS`):
  - `RPC_CMD_SHM_ALLOC` / `FREE`: Allocate or free shared memory
  - `RPC_CMD_LOAD_TA`: Load another Trusted Application (TA)
  - `RPC_CMD_FS` / `RPMB`: Access file system or secure storage (Replay Protected Memory Block)
  - `RPC_CMD_GPROF` / `TRACE`: Performance analysis or logging
- The REE kernel driver (typically `optee.ko`) handles these commands and interacts with the REE services.
- Shared memory is often used to pass complex structures and large data between REE and TEE.

---

## Why Is TA Calling `optee-supplicant` Considered an RPC?

- In OP-TEE, a **Trusted Application (TA)** may need to perform operations that it cannot handle on its own, such as:
  - Accessing the file system
  - Communicating with I2C devices
  - Reading the real-time clock (RTC)

- These operations often require assistance from the **Rich Execution Environment (REE)**, such as Linux.

- In such cases, the TA performs a **Remote Procedure Call (RPC)** to the `optee-supplicant`, which is a user-space daemon running in the REE.

### ðŸ”§ Example

When a TA wants to read a file from secure storage:

1. The TA makes an internal call to OP-TEE core.
2. OP-TEE core packages the request and issues an `OPTEE_MSG_RPC_CMD_*` to the supplicant.
3. `optee-supplicant` performs the action in Linux and returns the result to the TA.

### âœ… Why It's Considered RPC

- The communication:
  - Crosses **execution domains** (secure world to normal world)
  - Requires **context switching** between TEE and Linux
  - Follows a **request/response** model

> Even though it happens on the same device, the call meets the classic definition of an RPC (Remote Procedure Call).

---

## Conclusion

RPC in TEEs is a powerful mechanism that bridges the gap between secure and non-secure worlds. It enables trusted applications to leverage untrusted services in a controlled manner. However, it also introduces complexity and security challenges that require careful design and implementation.

As TEEs become more prevalent, understanding and properly securing RPC mechanisms will be key to building trustworthy, high-assurance systems.

